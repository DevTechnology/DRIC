/**
 * Javascript routines supporting DRIC application.
 * @author: jcaple, 6/20/2015
 */

var dric = {

	////////////////////////////////////////////////////////////////////////////////
	// Display the advanced search modal dialog.
	////////////////////////////////////////////////////////////////////////////////
	showAdvancedSearch : function() {
		dric.resetAdvancedSearchForm();
		$("#advancedSearchModal").modal('show');
	},

	////////////////////////////////////////////////////////////////////////////////
	// Set the value of the selected filter criteria in the specified filter field.
	////////////////////////////////////////////////////////////////////////////////
	setAdvancedFilterString : function(filterFld, value) {
		filterFld.val(value);
	},

	////////////////////////////////////////////////////////////////////////////////
	// Reset the advanced search form. 
	////////////////////////////////////////////////////////////////////////////////
	resetAdvancedSearchForm : function() {
		$("#advDrugSrchForm").val("");
		$("#recallTimeFilter").val("");
		$("#recallStatusFilter").val("");
		$("#classificationFilter").val("");
	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	performQuickSearch : function() {

	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	performQuickSearchCB : function(data) {

	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	performQuickSearchErr : function(msg) {

	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	resetQuickSearch : function() {

	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	loadRecentDrugReports : function() {
		dric.showLoadSpinner();
		setTimeout(function() {
			$.ajax({
				dataType: "json",
				type: "GET",
				url: "data/recents.json", 
				success: dric.loadRecentDrugReportsCB,
				error: dric.loadRecentDrugReportsErr
			});
		}, 3000);
	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	loadRecentDrugReportsCB : function(data) {
		try {
			var drugs = _.templateFromUrl("templates/drugRecallTable.html", data, {variable:"data"});
			$("#mainContent").html(drugs);

		} catch (e) {
			console.log("Unexpected error: " + e.message);
		}
	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	loadRecentDrugReportsErr : function(msg) {
		alert("Crapola!! " + msg.message);
	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	showLoadSpinner : function() {
		$("#mainContent").html("<div class='spinner'><center><img src='img/ajax-loader.gif' title='Loading Data...'></center></div>");
	},

	////////////////////////////////////////////////////////////////////////////////
	//  
	////////////////////////////////////////////////////////////////////////////////
	hideLoadSpinner : function() {
		$("#mainContent").html("");
	}

};


////////////////////////////////////////////////////////////////////////////////
// Mixin to load underscore templates from a file using ajax.  
////////////////////////////////////////////////////////////////////////////////
_.mixin({templateFromUrl: function (url, data, settings) {
	var templateHtml = "";
        this.cache = this.cache || {};

    	if (this.cache[url]) {
        	templateHtml = this.cache[url];
        } else {
	        $.ajax({
            		url: url,
		        method: "GET",
			dataType: "html", 
		        async: false,
		        success: function(data) {
		        	templateHtml = data;
			},
			error: function(data) {
				alert(data);
			}
            	});

           	this.cache[url] = templateHtml;
        }
	var t = _.template(templateHtml, settings);
	return t(data);
}});
